<template>
  <div class="page-container">
    <el-row type="flex">
      <el-col :span="5">
        <div>
          <div class="toolbar" style="float:left;padding-top:10px;padding-left:15px;width:100%;">
            <el-form :inline="true" :size="size">
              <el-form-item>
                <el-input v-model="filterName" placeholder="ËæìÂÖ•ÂÖ≥ÈîÆÂ≠óËøõË°åüîç" />
              </el-form-item>
            </el-form>
          </div>
          <div style="float:left;padding-top:10px;padding-left:15px;width:100%;">
            <el-tree
              ref="deptTree"
              :props="defaultProps"
              :load="loadNode"
              node-key="id"
              lazy
              :expand-on-click-node="false"
              :filter-node-method="filterNode"
              highlight-current
              @node-click="nodeClick"
            />
          </div>
        </div>
      </el-col>
      <el-col :span="18">
        <div class="toolbar" style="float:left;padding-top:10px;padding-left:15px;">
          <el-form :inline="true" :model="filters" :size="size">
            <el-form-item>
              <el-input v-model="filters.name" placeholder="Áî®Êà∑Ë¥¶Âè∑" />
            </el-form-item>
            <el-form-item>
              <el-input v-model="filters.nickName" placeholder="Áî®Êà∑ÊòµÁß∞" />
            </el-form-item>
            <el-form-item>
              <kt-button
                icon="el-icon-search"
                label="Êü•ËØ¢"
                perms="sys:user:findPage"
                type="primary"
                @click="findPage(null)"
              />
            </el-form-item>
            <el-form-item>
              <kt-button
                icon="fa fa-plus"
                label="Ê∑ªÂä†"
                perms="sys:user:add"
                type="primary"
                @click="handleAdd"
              />
            </el-form-item>
            <el-form-item>
              <el-upload
                class="upload-demo"
                :show-file-list="false"
                action
                :http-request="uploadFiles"
              >
                <kt-button
                  icon="el-icon-upload"
                  label="ÂØºÂÖ•"
                  perms="sys:user:import"
                  type="primary"
                />
              </el-upload>
            </el-form-item>
            <el-form-item>
              <kt-button
                icon="el-icon-download"
                label="ÂØºÂá∫"
                perms="sys:user:export"
                type="primary"
                @click="exportExcelUser"
              />
            </el-form-item>
            <el-form-item>
              <kt-button
                icon="el-icon-tickets"
                label="ÂØºÂá∫ÂÖ®ÈÉ®"
                perms="sys:user:export"
                type="primary"
                @click="exportAllExcelUser"
              />
            </el-form-item>
          </el-form>
        </div>
        <el-table
          v-loading="loading"
          :data="pageResult.content"
          :max-height="720"
          size="mini"
          align="left"
          @selection-change="handleSelectionChange"
          @current-change="handleCurrentChange"
        >
          <el-table-column header-align="center" align="center" type="selection" width="50" />
          <el-table-column header-align="center" align="center" prop="name" label="Áî®Êà∑Â∏êÂè∑" sortable />
          <el-table-column header-align="center" align="center" prop="nickName" label="Áî®Êà∑ÊòµÁß∞" sortable />
          <el-table-column header-align="center" align="center" prop="deptName" width="500" label="ÈÉ®Èó®" sortable />
<!--          <el-table-column header-align="center" align="center" prop="roleNames" label="ËßíËâ≤" sortable />-->
<!--          <el-table-column header-align="center" align="center" prop="email" label="ÈÇÆÁÆ±" sortable />-->
          <el-table-column header-align="center" align="center" prop="mobile" label="ÊâãÊú∫" sortable />
          <el-table-column label="Áä∂ÊÄÅ" align="center">
            <template slot-scope="scope">
              <el-switch
                v-model="scope.row.status"
                active-color="#13ce66"
                inactive-color="#ff4949"
                :active-value="1"
                :inactive-value="0"
                @change="change(scope.row)"
              />
            </template>
          </el-table-column>
          <el-table-column label="Êìç‰Ωú" width="280" align="center">
            <template slot-scope="scope">
              <kt-button
                icon="fa fa-edit"
                label="ÁºñËæë"
                perms="sys:user:edit"
                @click="handleEdit(scope)"
              />
              <kt-button
                icon="fa fa-trash"
                label="Âà†Èô§"
                perms="sys:user:delete"
                type="danger"
                @click="handleDelete(scope.row)"
              />
              <kt-button
                icon="fa fa-cog"
                label="ÈáçÁΩÆÂØÜÁ†Å"
                perms="sys:user:resetPwd"
                type="danger"
                @click="resetPwd(scope.row)"
              />
            </template>
          </el-table-column>
        </el-table>
        <div class="toolbar" style="padding:10px;">
          <kt-button
            label="ÊâπÈáèÂà†Èô§"
            perms="sys:user:delete"
            :size="size"
            type="danger"
            :disabled="selections.length === 0"
            style="float:left;"
            @click="handleBatchDelete()"
          />
          <kt-button
            label="ÊâπÈáèÈáçÁΩÆÂØÜÁ†Å"
            perms="sys:user:resetPwd"
            :size="size"
            type="danger"
            :disabled="selections.length === 0"
            @click="batchResetPwd()"
          />
          <pagination
            v-show="pageRequest.total>0"
            :total="pageRequest.total"
            :page.sync="pageRequest.pageNum"
            :limit.sync="pageRequest.pageSize"
            @pagination="findPage"
          />
        </div>
      </el-col>
    </el-row>
    <el-dialog :title="operation?'Êñ∞Â¢û':'ÁºñËæë'" width="40%" :visible.sync="dialogVisible" :close-on-click-modal="false">
      <el-form
        ref="dataForm"
        :model="dataForm"
        label-width="80px"
        :rules="dataFormRules"
        :size="size"
        label-position="right"
      >
        <el-form-item v-if="false" label="ID" prop="id">
          <el-input v-model="dataForm.id" :disabled="true" auto-complete="off" />
        </el-form-item>
        <el-form-item label="Áî®Êà∑Â∏êÂè∑" prop="name">
          <el-input v-if="isEdit" v-model="dataForm.name" auto-complete="off" :disabled="true" />
          <el-input v-else-if="!isEdit" v-model="dataForm.name" auto-complete="off" />
        </el-form-item>
        <el-form-item label="Áî®Êà∑ÊòµÁß∞" prop="nickName">
          <el-input v-model="dataForm.nickName" auto-complete="off" />
        </el-form-item>
        <el-form-item label="ÂØÜÁ†Å" prop="password">
          <el-input v-model="dataForm.password" type="password" auto-complete="off" />
        </el-form-item>
        <el-form-item label="ÈÉ®Èó®" prop="deptName">
          <el-input v-model="dataForm.deptName" auto-complete="off" disabled @click.native="getUserDeptTree" />
          <el-tree
            v-show="isShowUserDeptTree"
            ref="userDeptTree"
            :props="defaultProps"
            :load="loadNode"
            node-key="id"
            lazy
            :expand-on-click-node="false"
            :filter-node-method="filterNode"
            highlight-current
            @node-click="userNodeClick"
          />
        </el-form-item>
        <el-form-item label="ÈÇÆÁÆ±" prop="email">
          <el-input v-model="dataForm.email" auto-complete="off" />
        </el-form-item>
        <el-form-item label="ÊâãÊú∫" prop="mobile">
          <el-input v-model="dataForm.mobile" auto-complete="off" />
        </el-form-item>
        <el-form-item label="ÊéíÂ∫èÂÄº" prop="orderNum">
          <el-input-number v-model="dataForm.orderNum" controls-position="right" :min="0" label="ÊéíÂ∫èÂÄº" />
        </el-form-item>
        <el-form-item label="ËßíËâ≤" prop="userRoles">
          <el-select v-model="dataForm.userRoles" multiple placeholder="ËØ∑ÈÄâÊã©" style="width: 100%;">
            <el-option v-for="item in roles" :key="item.id" :label="item.name" :value="item.id" />
          </el-select>
        </el-form-item>
      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button :size="size" @click.native="dialogVisible = false">ÂÖ≥Èó≠</el-button>
        <el-button :size="size" type="primary" :loading="editLoading" @click.native="submitForm">
          Êèê‰∫§
        </el-button>
      </div>
    </el-dialog>
  </div>
</template>

<script>
import KtButton from '@/components/KtButton'
import { format } from '@/utils/datetime'
import Pagination from '@/components/Pagination'
import { findPage, save, userStatusSwitching, findUserRoles, batchDelete, resetPwd, importUserExcel, exportExcelUser, exportAllExcelUser } from '@/api/admin-server/user'
import { uploadFiles } from '@/api/admin-server/attachments'
import { asyncFindTree, findDeptTree } from '@/api/admin-server/dept'
import { findAll } from '@/api/admin-server/role'
export default {
  components: {
    KtButton,
    Pagination
  },
  data() {
    return {
      size: 'small',
      filters: {
        name: '',
        nickName: '',
        deptId: ''
      },
      loading: false,
      columns: [],
      filterColumns: [],
      pageRequest: { pageNum: 1, pageSize: 10, total: 0 },
      pageResult: {},

      operation: false, // true:Êñ∞Â¢û, false:ÁºñËæë
      dialogVisible: false, // Êñ∞Â¢ûÁºñËæëÁïåÈù¢ÊòØÂê¶ÊòæÁ§∫
      editLoading: false,
      dataFormRules: {
        name: [
          { required: true, message: 'ËØ∑ËæìÂÖ•Áî®Êà∑Ë¥¶Âè∑', trigger: 'blur' }
        ]
      },
      isEdit: false,
      // Êñ∞Â¢ûÁºñËæëÁïåÈù¢Êï∞ÊçÆ
      dataForm: {
        id: '',
        name: '',
        nickName: '',
        password: '',
        deptId: '',
        deptName: '',
        email: '',
        mobile: '',
        orderNum: 0,
        status: '',
        userRoles: []
      },
      deptData: [],
      deptTreeProps: {
        label: 'name',
        children: 'children'
      },
      roles: [],
      selections: [], // ÂàóË°®ÈÄâ‰∏≠Âàó
      defaultProps: { // tree Êéß‰ª∂ÁöÑÊï∞ÊçÆÁªìÊûÑÔºåÈúÄË¶ÅËÆæÁΩÆ isLeaf
        children: 'children',
        label: 'name',
        isLeaf: 'hasChildren'
      },
      currDeptNode: null,
      filterName: '',
      isShowUserDeptTree: false
    }
  },
  watch: {
    filterName(val) {
      this.$refs.deptTree.filter(val)
    }
  },
  created() {
    this.findPage()
  },
  mounted() {
    this.findDeptTree()
    this.initColumns()
  },
  methods: {
    // Ëé∑ÂèñÂàÜÈ°µÊï∞ÊçÆ
    findPage: function(data) {
      this.loading = true
      this.pageRequest.params = { name: this.filters.name, nickName: this.filters.nickName, deptId: this.filters.deptId }
      findPage(this.pageRequest).then((res) => {
        this.loading = false
        this.pageResult = res.data
        this.pageRequest.total = this.pageResult.totalSize
        this.pageRequest.pageNum = this.pageResult.pageNum
        this.pageRequest.pageSize = this.pageResult.pageSize
        this.findRoles()
      }).then(data != null ? data.callback : '')
    },
    uploadFiles(fileObject) {
      const formData = new FormData()
      formData.set('file', fileObject.file)
      uploadFiles(formData).then(response => {
        const { data } = response
        this.importUserExcel(data)
        this.$message({ message: response, type: 'success' })
      })
    },
    importUserExcel: function(data) {
      importUserExcel(data).then(response => {
        this.$message({ message: response, type: 'success' })
      })
    },
    exportExcelUser: function() {
      this.pageRequest.params = { name: this.filters.name, deptId: this.filters.deptId }
      exportExcelUser(this.pageRequest).then((response) => {
        console.log(response)
        const blob = new Blob([response], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=utf-8' })
        console.log(blob)
        const filename = 'ÈóÆÂç∑‰ø°ÊÅØ.xlsx'
        if (window.navigator.msSaveOrOpenBlob) { // ÂÖºÂÆπIE10
          navigator.msSaveBlob(blob, filename)
        } else {
          // ÂàõÂª∫‰∏Ä‰∏™Ë∂ÖÈìæÊé•ÔºåÂ∞ÜÊñá‰ª∂ÊµÅËµãËøõÂéªÔºåÁÑ∂ÂêéÂÆûÁé∞Ëøô‰∏™Ë∂ÖÈìæÊé•ÁöÑÂçïÂáª‰∫ã‰ª∂
          const elink = document.createElement('a')
          elink.download = filename
          elink.style.display = filename
          elink.href = URL.createObjectURL(blob)
          document.body.appendChild(elink)
          elink.click()
          URL.revokeObjectURL(elink.href) // ÈáäÊîæURL ÂØπË±°
          document.body.removeChild(elink)
        }
      })
    },
    exportAllExcelUser() {
      const loading = this.$loading({
        lock: true,
        text: 'ÂÖ®Á≥ªÁªüÁî®Êà∑ÂØºÂá∫‰∏≠ÔºåÈúÄË¶ÅÊó∂Èó¥ÂèØËÉΩ‰ºö‰πÖ‰∏Ä‰∫õÔºåËØ∑ËÄêÂøÉÁ≠âÂæÖ......',
        spinner: 'el-icon-loading',
        background: 'rgba(0, 0, 0, 0.7)'
      })
      exportAllExcelUser().then((response) => {
        console.log(response)
        const blob = new Blob([response], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;charset=utf-8' })
        console.log(blob)
        const filename = '‰∏ÄÈÉ®ÊâãÊú∫ÊãõÂïÜÈÄöË¥¶Âè∑‰ø°ÊÅØ.xlsx'
        if (window.navigator.msSaveOrOpenBlob) { // ÂÖºÂÆπIE10
          navigator.msSaveBlob(blob, filename)
        } else {
          // ÂàõÂª∫‰∏Ä‰∏™Ë∂ÖÈìæÊé•ÔºåÂ∞ÜÊñá‰ª∂ÊµÅËµãËøõÂéªÔºåÁÑ∂ÂêéÂÆûÁé∞Ëøô‰∏™Ë∂ÖÈìæÊé•ÁöÑÂçïÂáª‰∫ã‰ª∂
          const elink = document.createElement('a')
          elink.download = filename
          elink.style.display = filename
          elink.href = URL.createObjectURL(blob)
          document.body.appendChild(elink)
          elink.click()
          URL.revokeObjectURL(elink.href) // ÈáäÊîæURL ÂØπË±°
          document.body.removeChild(elink)
          loading.close()
        }
      })
    },
    handleChange(file, fileList) {
      console.log(file)
    },
    // Âä†ËΩΩËßíËâ≤‰ø°ÊÅØ
    findRoles: function() {
      findAll().then((res) => {
        // Âä†ËΩΩËßíËâ≤ÈõÜÂêà
        this.roles = res.data
      })
    },
    // Âä†ËΩΩÁî®Êà∑ËßíËâ≤‰ø°ÊÅØ
    findUserRoles: function(data) {
      findUserRoles({ userId: data.id }).then((res) => {
        const roles = res.data
        const userRoles = []
        for (let i = 0, len = roles.length; i < len; i++) {
          userRoles.push(roles[i].roleId)
        }
        this.dataForm.userRoles = userRoles
      })
    },
    // Âà†Èô§
    handleDelete: function(data) {
      this.delete(data.id)
    },
    // ÊâπÈáèÂà†Èô§
    handleBatchDelete: function() {
      const ids = this.selections.map(item => item.id).toString()
      this.delete(ids)
    },
    delete: function(ids) {
      this.$confirm('Á°ÆËÆ§Âà†Èô§ÈÄâ‰∏≠ËÆ∞ÂΩïÂêóÔºü', 'ÊèêÁ§∫', {
        type: 'warning'
      }).then(() => {
        const params = []
        const idArray = (ids + '').split(',')
        for (var i = 0; i < idArray.length; i++) {
          params.push({ 'id': idArray[i] })
        }
        batchDelete(params).then((res) => {
          if (res.code === 200) {
            this.$message({ message: 'Êìç‰ΩúÊàêÂäü', type: 'success' })
            this.findPage(null)
          } else {
            this.$message({ message: 'Êìç‰ΩúÂ§±Ë¥•, ' + res.msg, type: 'error' })
          }
        })
      })
    },
    batchResetPwd: function() {
      const ids = this.selections.map(item => item.id)
      this.$confirm('Á°ÆËÆ§ÈáçÁΩÆÂΩìÂâçÁî®Êà∑ÂØÜÁ†ÅÂêóÔºü', 'ÊèêÁ§∫', {
        type: 'warning'
      }).then(() => {
        this.loading = true
        ids.forEach(id => {
          resetPwd(id).then((res) => {
            if (res.code === 200) {
              this.$message({ message: res.msg, type: 'success' })
              this.findPage(null)
            } else {
              this.$message({ message: 'Êìç‰ΩúÂ§±Ë¥•, ' + res.msg, type: 'error' })
            }
            this.loading = false
          })
        })
      })
    },
    // ÈáçÁΩÆÂØÜÁ†Å
    resetPwd: function(data) {
      this.$confirm('Á°ÆËÆ§ÈáçÁΩÆÂΩìÂâçÁî®Êà∑ÂØÜÁ†ÅÂêóÔºü', 'ÊèêÁ§∫', {
        type: 'warning'
      }).then(() => {
        this.loading = true
        const id = data.id
        resetPwd(id).then((res) => {
          if (res.code === 200) {
            this.$message({ message: res.msg, type: 'success' })
            this.findPage(null)
          } else {
            this.$message({ message: 'Êìç‰ΩúÂ§±Ë¥•, ' + res.msg, type: 'error' })
          }
          this.loading = false
        })
      }).catch(() => {
      })
    },
    handleCurrentChange: function() {

    },
    handleSelectionChange: function(selections) {
      this.selections = selections
      console.log(this.selections)
    },
    change: function(data) {
      userStatusSwitching(data).then((res) => {
        this.editLoading = false
        if (res.code === 200) {
          this.$message({ message: 'Êìç‰ΩúÊàêÂäü', type: 'success' })
        } else {
          this.$message({ message: 'Êìç‰ΩúÂ§±Ë¥•, ' + res.msg, type: 'error' })
        }
        this.findPage(null)
      })
    },
    // ÊòæÁ§∫Êñ∞Â¢ûÁïåÈù¢
    handleAdd: function() {
      if (this.currDeptNode === null) {
        this.$message({ message: 'ËØ∑ÈÄâÊã©ÊâÄÂ±ûÈÉ®Èó®ÔºÅ', type: 'error' })
        return
      }
      if (this.$refs['dataForm'] !== undefined) {
        this.$refs['dataForm'].resetFields()
      }
      this.isShowUserDeptTree = false
      this.dataForm = {
        id: '',
        name: '',
        nickName: '',
        password: '',
        deptId: this.currDeptNode.id,
        deptName: this.currDeptNode.name,
        email: '',
        mobile: '',
        status: '',
        userRoles: []
      }
      this.dialogVisible = true
      this.operation = true
      this.isEdit = false
    },
    // ÊòæÁ§∫ÁºñËæëÁïåÈù¢
    handleEdit: function(params) {
      if (this.$refs['dataForm'] !== undefined) {
        this.$refs['dataForm'].resetFields()
      }
      this.isShowUserDeptTree = false
      this.isEdit = true
      this.dialogVisible = true
      this.operation = false
      this.dataForm = Object.assign({}, params.row)
      this.findUserRoles(params.row)
    },
    // ÁºñËæë
    submitForm: function() {
      if (this.dataForm.deptId === '') {
        this.$message({ message: 'ËØ∑ÈÄâÊã©ÊâÄÂ±ûÈÉ®Èó®ÔºÅ', type: 'error' })
        return
      }
      this.$refs.dataForm.validate((valid) => {
        if (valid) {
          this.$confirm('Á°ÆËÆ§Êèê‰∫§ÂêóÔºü', 'ÊèêÁ§∫', {}).then(() => {
            this.editLoading = true
            const params = Object.assign({}, this.dataForm)
            const userRoles = []
            for (let i = 0, len = params.userRoles.length; i < len; i++) {
              const userRole = {
                userId: params.id,
                roleId: params.userRoles[i]
              }
              userRoles.push(userRole)
            }
            params.userRoles = userRoles
            save(params).then((res) => {
              this.editLoading = false
              if (res.code === 200) {
                this.$message({ message: 'Êìç‰ΩúÊàêÂäü', type: 'success' })
                this.dialogVisible = false
              } else {
                this.$message({ message: 'Êìç‰ΩúÂ§±Ë¥•, ' + res.msg, type: 'error' })
                this.dialogVisible = false
              }
              this.findPage(null)
            })
          })
        }
      })
    },
    // Ëé∑ÂèñÈÉ®Èó®ÂàóË°®
    findDeptTree: function() {
      findDeptTree().then((res) => {
        this.deptData = res.data
      })
    },
    // ËèúÂçïÊ†ëÈÄâ‰∏≠
    deptTreeCurrentChangeHandle(data, node) {
      console.log(node)
      this.dataForm.deptId = data.id
      this.dataForm.deptName = data.name
    },
    // Êó∂Èó¥Ê†ºÂºèÂåñ
    dateFormat: function(row, column, cellValue, index) {
      console.log(cellValue)
      console.log(index)
      return format(row[column.property])
    },
    // Â§ÑÁêÜË°®Ê†ºÂàóËøáÊª§ÊòæÁ§∫
    displayFilterColumnsDialog: function() {
      this.$refs.tableColumnFilterDialog.setDialogVisible(true)
    },
    // Â§ÑÁêÜË°®Ê†ºÂàóËøáÊª§ÊòæÁ§∫
    handleFilterColumns: function(data) {
      this.filterColumns = data.filterColumns
      this.$refs.tableColumnFilterDialog.setDialogVisible(false)
    },
    // Â§ÑÁêÜË°®Ê†ºÂàóËøáÊª§ÊòæÁ§∫
    initColumns: function() {
      this.columns = [
        { prop: 'id', label: 'ID', minWidth: 50 },
        { prop: 'name', label: 'Áî®Êà∑Ë¥¶Âè∑', minWidth: 120 },
        { prop: 'nickName', label: 'Áî®Êà∑ÊòµÁß∞', minWidth: 120 },
        { prop: 'deptName', label: 'ÈÉ®Èó®', minWidth: 120 },
        { prop: 'roleNames', label: 'ËßíËâ≤', minWidth: 100 },
        { prop: 'email', label: 'ÈÇÆÁÆ±', minWidth: 120 },
        { prop: 'mobile', label: 'ÊâãÊú∫', minWidth: 100 },
        { prop: 'status', label: 'Áä∂ÊÄÅ', minWidth: 70 }
      ]
      this.filterColumns = JSON.parse(JSON.stringify(this.columns))
    },
    async loadNode(node, resolve) {
      if (node.level === 0) {
        return resolve(await this.getTagList())
      } else {
        console.log(node)
        return resolve(await this.getTagApiList(node.data.id))
      }
    },
    async getTagList() {
      const res = await asyncFindTree(0)
      const tags = res.data
      return tags
    },
    async getTagApiList(tag) {
      console.log(tag)
      const res = await asyncFindTree(tag)
      const results = res.data
      return results
    },
    filterNode(value, data) {
      if (!value) return true
      return data.name.indexOf(value) !== -1
    },
    nodeClick(data, node) {
      if (this.currDeptNode && this.currDeptNode === data) {
        this.currDeptNode = null
        this.filters.deptId = ''
        node.isCurrent = false
      } else {
        this.currDeptNode = data
        this.filters.deptId = data.id
        node.isCurrent = true
      }
      this.findPage(null)
    },
    getUserDeptTree() {
      this.isShowUserDeptTree = true
    },
    userNodeClick(data, node) {
      this.dataForm.deptId = data.id
      this.dataForm.deptName = data.name
      this.isShowUserDeptTree = false
      this.findPage(null)
    }

  }
}
</script>
<style scoped>
.custom-tree-node {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 15px;
    padding-right: 8px;
  }
</style>
